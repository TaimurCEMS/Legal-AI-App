rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: Get orgId from document
    function getOrgId(doc) {
      return doc.data.orgId;
    }
    
    // Helper function: Check if user is active member of org
    function isActiveMember(orgId) {
      let memberId = orgId + '_' + request.auth.uid;
      let memberDoc = get(/databases/$(database)/documents/org_members/$(memberId));
      return memberDoc != null 
        && memberDoc.data.status == 'active'
        && (!('deletedAt' in memberDoc.data) || memberDoc.data.deletedAt == null);
    }
    
    // Helper function: Get user role in org
    function getUserRole(orgId) {
      let memberId = orgId + '_' + request.auth.uid;
      let memberDoc = get(/databases/$(database)/documents/org_members/$(memberId));
      return memberDoc != null ? memberDoc.data.role : null;
    }
    
    // Helper function: Check if user has admin or owner role
    function isAdminOrOwner(orgId) {
      let role = getUserRole(orgId);
      return role == 'admin' || role == 'owner';
    }
    
    // Hard deny: doc_chunks is server-only
    match /doc_chunks/{chunkId} {
      allow read, write: if false;
    }
    
    // orgs: read-only for active members
    match /orgs/{orgId} {
      allow read: if isAuthenticated() && isActiveMember(orgId);
      allow write: if false; // Server-only via Admin SDK
    }
    
    // org_members: read-only for active members of that org
    match /org_members/{memberId} {
      // memberId format: {orgId}_{userId}
      allow read: if isAuthenticated() && 
        (memberId.matches('.*_' + request.auth.uid) || 
         (resource.data.orgId != null && isActiveMember(resource.data.orgId)));
      allow write: if false; // Server-only via Admin SDK
    }
    
    // Existing top-level cases collection (legacy)
    match /cases/{caseId} {
      allow read: if isAuthenticated() &&
        resource.data.orgId != null &&
        isActiveMember(resource.data.orgId);
      allow write: if false;
    }
    
    // documents: read-only for active members
    match /documents/{docId} {
      allow read: if isAuthenticated() && 
        resource.data.orgId != null &&
        isActiveMember(resource.data.orgId);
      allow write: if false; // Server-only via Admin SDK
    }
    
    // ai_requests: read-only for active members
    match /ai_requests/{reqId} {
      allow read: if isAuthenticated() && 
        resource.data.orgId != null &&
        isActiveMember(resource.data.orgId);
      allow write: if false; // Server-only via Admin SDK
    }
    
    // ai_outputs: read-only for active members
    match /ai_outputs/{outId} {
      allow read: if isAuthenticated() && 
        resource.data.orgId != null &&
        isActiveMember(resource.data.orgId);
      allow write: if false; // Server-only via Admin SDK
      
      // ai_outputs parts subcollection: read-only for members of output's org
      match /parts/{partId} {
        allow read: if isAuthenticated() && 
          get(/databases/$(database)/documents/ai_outputs/$(outId)).data.orgId != null &&
          isActiveMember(get(/databases/$(database)/documents/ai_outputs/$(outId)).data.orgId);
        allow write: if false; // Server-only via Admin SDK
      }
    }
    
    // audit_logs: read-only for owner/admin roles only
    match /audit_logs/{logId} {
      allow read: if isAuthenticated() && 
        resource.data.orgId != null &&
        isAdminOrOwner(resource.data.orgId);
      allow write: if false; // Server-only via Admin SDK
    }
    
    // Slice 2: Cases under organizations collection
    // This aligns with the new Case Hub implementation.
    function isOrgMember(orgId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }

    match /organizations/{orgId}/cases/{caseId} {
      // Read: user must be org member AND
      //   (case is ORG_WIDE OR user is creator for PRIVATE) AND
      //   case is not soft-deleted
      allow read: if isOrgMember(orgId) &&
        resource.data.visibility != null &&
        (
          resource.data.visibility == 'ORG_WIDE' ||
          resource.data.createdBy == request.auth.uid
        ) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 3: Clients under organizations collection
    match /organizations/{orgId}/clients/{clientId} {
      // Read: org members can read non-deleted clients
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 4: Documents under organizations collection
    match /organizations/{orgId}/documents/{documentId} {
      // Read: org members can read non-deleted documents
      // If document is linked to a case, case visibility is checked in Cloud Functions
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      // Case-level permissions are enforced in Cloud Functions
      allow create, update, delete: if false;
    }

    // Slice 2.5: Members under organizations collection
    match /organizations/{orgId}/members/{memberId} {
      // Read: All org members can read other members (for team visibility)
      // Note: All org members can see other members (simpler, better for team collaboration)
      // If privacy is required, restrict to ADMIN-only in future
      allow read: if isOrgMember(orgId);
      
      // Deny all writes (only via Cloud Functions)
      allow write: if false;
    }

    // Slice 5: Tasks under organizations collection
    match /organizations/{orgId}/tasks/{taskId} {
      // Read: org members can read non-deleted tasks
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 7: Events (Calendar) under organizations collection
    match /organizations/{orgId}/events/{eventId} {
      // Read: org members can read non-deleted events
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 7: Scheduled Reminders under organizations collection
    match /organizations/{orgId}/scheduledReminders/{reminderId} {
      // Read: org members can read their own reminders
      allow read: if isOrgMember(orgId) &&
        resource.data.recipientUid == request.auth.uid;

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Default deny for all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

