rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: Get orgId from document
    function getOrgId(doc) {
      return doc.data.orgId;
    }
    
    // Helper function: Check if user is active member of org
    function isActiveMember(orgId) {
      let memberId = orgId + '_' + request.auth.uid;
      let memberDoc = get(/databases/$(database)/documents/org_members/$(memberId));
      return memberDoc != null 
        && memberDoc.data.status == 'active'
        && (!('deletedAt' in memberDoc.data) || memberDoc.data.deletedAt == null);
    }
    
    // Helper function: Get user role in org
    function getUserRole(orgId) {
      let memberId = orgId + '_' + request.auth.uid;
      let memberDoc = get(/databases/$(database)/documents/org_members/$(memberId));
      return memberDoc != null ? memberDoc.data.role : null;
    }
    
    // Helper function: Check if user has admin or owner role
    function isAdminOrOwner(orgId) {
      let role = getUserRole(orgId);
      return role == 'admin' || role == 'owner';
    }
    
    // Hard deny: doc_chunks is server-only
    match /doc_chunks/{chunkId} {
      allow read, write: if false;
    }

    // P1: domain_events and outbox are server-only (Cloud Functions Admin SDK)
    match /domain_events/{eventId} {
      allow read, write: if false;
    }
    match /outbox/{outboxId} {
      allow read, write: if false;
    }

    // P2: notifications – recipient can read their own only (org-scoped)
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() &&
        resource.data.recipientUid == request.auth.uid;
      allow write: if false;
    }
    // P2: notification_preferences – user can read/write their own only (doc id: orgId_uid_category)
    match /notification_preferences/{prefId} {
      allow read: if isAuthenticated() &&
        (resource != null && resource.data.uid == request.auth.uid);
      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid;
      allow update, delete: if isAuthenticated() &&
        resource.data.uid == request.auth.uid;
    }
    // P2: notification_templates – admin can manage (server-only for v1)
    match /notification_templates/{templateId} {
      allow read, write: if false;
    }
    // P2: suppression_list – admin view/manage, system write (server-only for v1)
    match /suppression_list/{suppressionId} {
      allow read, write: if false;
    }
    
    // orgs: read-only for active members
    match /orgs/{orgId} {
      allow read: if isAuthenticated() && isActiveMember(orgId);
      allow write: if false; // Server-only via Admin SDK
    }
    
    // org_members: read-only for active members of that org
    match /org_members/{memberId} {
      // memberId format: {orgId}_{userId}
      allow read: if isAuthenticated() && 
        (memberId.matches('.*_' + request.auth.uid) || 
         (resource.data.orgId != null && isActiveMember(resource.data.orgId)));
      allow write: if false; // Server-only via Admin SDK
    }
    
    // Existing top-level cases collection (legacy)
    match /cases/{caseId} {
      allow read: if isAuthenticated() &&
        resource.data.orgId != null &&
        isActiveMember(resource.data.orgId);
      allow write: if false;
    }
    
    // documents: read-only for active members
    match /documents/{docId} {
      allow read: if isAuthenticated() && 
        resource.data.orgId != null &&
        isActiveMember(resource.data.orgId);
      allow write: if false; // Server-only via Admin SDK
    }
    
    // ai_requests: read-only for active members
    match /ai_requests/{reqId} {
      allow read: if isAuthenticated() && 
        resource.data.orgId != null &&
        isActiveMember(resource.data.orgId);
      allow write: if false; // Server-only via Admin SDK
    }
    
    // ai_outputs: read-only for active members
    match /ai_outputs/{outId} {
      allow read: if isAuthenticated() && 
        resource.data.orgId != null &&
        isActiveMember(resource.data.orgId);
      allow write: if false; // Server-only via Admin SDK
      
      // ai_outputs parts subcollection: read-only for members of output's org
      match /parts/{partId} {
        allow read: if isAuthenticated() && 
          get(/databases/$(database)/documents/ai_outputs/$(outId)).data.orgId != null &&
          isActiveMember(get(/databases/$(database)/documents/ai_outputs/$(outId)).data.orgId);
        allow write: if false; // Server-only via Admin SDK
      }
    }
    
    // audit_logs: read-only for owner/admin roles only
    match /audit_logs/{logId} {
      allow read: if isAuthenticated() && 
        resource.data.orgId != null &&
        isAdminOrOwner(resource.data.orgId);
      allow write: if false; // Server-only via Admin SDK
    }
    
    // Slice 2: Cases under organizations collection
    // This aligns with the new Case Hub implementation.
    function isOrgMember(orgId) {
      return request.auth != null &&
        exists(/databases/$(database)/documents/organizations/$(orgId)/members/$(request.auth.uid));
    }

    // Helper: Case access (ORG_WIDE, PRIVATE creator, PRIVATE participants)
    function canAccessCase(orgId, caseId) {
      let caseDoc = get(/databases/$(database)/documents/organizations/$(orgId)/cases/$(caseId));
      return caseDoc != null &&
        (!('deletedAt' in caseDoc.data) || caseDoc.data.deletedAt == null) &&
        (
          caseDoc.data.visibility == 'ORG_WIDE' ||
          caseDoc.data.createdBy == request.auth.uid ||
          exists(/databases/$(database)/documents/organizations/$(orgId)/cases/$(caseId)/participants/$(request.auth.uid))
        );
    }

    // Helper: Invoice access (invoice exists, not deleted, and user can access its case)
    function canAccessInvoice(orgId, invoiceId) {
      let inv = get(/databases/$(database)/documents/organizations/$(orgId)/invoices/$(invoiceId));
      return inv != null &&
        (!('deletedAt' in inv.data) || inv.data.deletedAt == null) &&
        ('caseId' in inv.data) &&
        inv.data.caseId != null &&
        canAccessCase(orgId, inv.data.caseId);
    }

    match /organizations/{orgId}/cases/{caseId} {
      // Read: user must be org member AND
      //   (case is ORG_WIDE OR PRIVATE creator OR PRIVATE participant) AND
      //   case is not soft-deleted
      allow read: if isOrgMember(orgId) &&
        resource.data.visibility != null &&
        (
          resource.data.visibility == 'ORG_WIDE' ||
          resource.data.createdBy == request.auth.uid ||
          exists(/databases/$(database)/documents/organizations/$(orgId)/cases/$(caseId)/participants/$(request.auth.uid))
        ) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 3: Clients under organizations collection
    match /organizations/{orgId}/clients/{clientId} {
      // Read: org members can read non-deleted clients
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 4: Documents under organizations collection
    match /organizations/{orgId}/documents/{documentId} {
      // Read: org members can read non-deleted documents
      // If document is linked to a case, enforce case access defense-in-depth
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null) &&
        (!('caseId' in resource.data) || resource.data.caseId == null || canAccessCase(orgId, resource.data.caseId));

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      // Case-level permissions are enforced in Cloud Functions
      allow create, update, delete: if false;
    }

    // Slice 2.5: Members under organizations collection
    match /organizations/{orgId}/members/{memberId} {
      // Read: All org members can read other members (for team visibility)
      // Note: All org members can see other members (simpler, better for team collaboration)
      // If privacy is required, restrict to ADMIN-only in future
      allow read: if isOrgMember(orgId);
      
      // Deny all writes (only via Cloud Functions)
      allow write: if false;
    }

    // Slice 5: Tasks under organizations collection
    match /organizations/{orgId}/tasks/{taskId} {
      // Read: org members can read non-deleted tasks
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null) &&
        (!('caseId' in resource.data) || resource.data.caseId == null || canAccessCase(orgId, resource.data.caseId));

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 7: Events (Calendar) under organizations collection
    match /organizations/{orgId}/events/{eventId} {
      // Read: org members can read non-deleted events
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null) &&
        (!('caseId' in resource.data) || resource.data.caseId == null || canAccessCase(orgId, resource.data.caseId));

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 7: Scheduled Reminders under organizations collection
    match /organizations/{orgId}/scheduledReminders/{reminderId} {
      // Read: org members can read their own reminders
      allow read: if isOrgMember(orgId) &&
        resource.data.recipientUid == request.auth.uid;

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 8: Notes under organizations collection
    // Note visibility inherits from case (checked in Cloud Functions)
    match /organizations/{orgId}/notes/{noteId} {
      // Read: org members can read non-deleted notes
      // Case-level access enforced here (defense-in-depth) and in Cloud Functions.
      // Private-to-me notes are creator-only.
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null) &&
        (!('caseId' in resource.data) || resource.data.caseId == null || canAccessCase(orgId, resource.data.caseId)) &&
        (!('isPrivate' in resource.data) || resource.data.isPrivate != true || resource.data.createdBy == request.auth.uid);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 9: Draft templates and drafts under organizations collection
    // Drafts are case-linked and must follow case access (defense-in-depth).
    match /organizations/{orgId}/draftTemplates/{templateId} {
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);
      allow create, update, delete: if false;
    }

    match /organizations/{orgId}/drafts/{draftId} {
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null) &&
        ('caseId' in resource.data) &&
        resource.data.caseId != null &&
        canAccessCase(orgId, resource.data.caseId);

      allow create, update, delete: if false;

      match /versions/{versionId} {
        allow read: if isOrgMember(orgId) &&
          canAccessCase(orgId, get(/databases/$(database)/documents/organizations/$(orgId)/drafts/$(draftId)).data.caseId);
        allow write: if false;
      }
    }

    // Slice 10: Time Entries under organizations collection
    // Time entries may be case-linked; enforce case access defense-in-depth.
    match /organizations/{orgId}/timeEntries/{timeEntryId} {
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null) &&
        (!('caseId' in resource.data) || resource.data.caseId == null || canAccessCase(orgId, resource.data.caseId));

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;
    }

    // Slice 16: Comments under organizations collection (case access)
    match /organizations/{orgId}/comments/{commentId} {
      allow read: if isOrgMember(orgId) &&
        ('matterId' in resource.data) &&
        resource.data.matterId != null &&
        canAccessCase(orgId, resource.data.matterId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null);
      allow create, update, delete: if false;
    }

    // Slice 14: Document summaries under organizations collection
    match /organizations/{orgId}/document_summaries/{summaryId} {
      allow read: if isOrgMember(orgId) &&
        (!('caseId' in resource.data) || resource.data.caseId == null || canAccessCase(orgId, resource.data.caseId));
      allow create, update, delete: if false;
    }

    // Slice 11: Invoices under organizations collection
    // Invoices are case-linked; enforce case access defense-in-depth.
    match /organizations/{orgId}/invoices/{invoiceId} {
      allow read: if isOrgMember(orgId) &&
        (!('deletedAt' in resource.data) || resource.data.deletedAt == null) &&
        ('caseId' in resource.data) &&
        resource.data.caseId != null &&
        canAccessCase(orgId, resource.data.caseId);

      // All writes are via Admin SDK (Cloud Functions); deny direct client writes
      allow create, update, delete: if false;

      match /lineItems/{lineItemId} {
        allow read: if isOrgMember(orgId) && canAccessInvoice(orgId, invoiceId);
        allow write: if false;
      }

      match /payments/{paymentId} {
        allow read: if isOrgMember(orgId) && canAccessInvoice(orgId, invoiceId);
        allow write: if false;
      }
    }

    // Default deny for all other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

